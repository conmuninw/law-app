import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, query, addDoc, updateDoc, deleteDoc, serverTimestamp } from 'firebase/firestore';
import { 
  Scale, Plus, Brain, Save, Trash2, Layout, 
  ChevronRight, Camera, Loader2, Calendar, BookOpen, 
  Sparkles, Check, ExternalLink, Highlighter, Edit3,
  Clock, AlertCircle, ListTodo, X, SaveAll, MapPin,
  Search, Bookmark, Target, Filter
} from 'lucide-react';

// --- Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'law-study-v12';

const App = () => {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [selectedSubject, setSelectedSubject] = useState(null);
  const [notes, setNotes] = useState([]);
  const [schedules, setSchedules] = useState([]);
  const [homework, setHomework] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  
  const [isScanning, setIsScanning] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [scanPreview, setScanPreview] = useState(null);
  const [editingNoteId, setEditingNoteId] = useState(null);
  const [highlightingNoteId, setHighlightingNoteId] = useState(null);
  
  const fileInputRef = useRef(null);

  const subjects = [
    { id: 'crim2', name: '‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏ç‡∏≤ 2', icon: '‚öñÔ∏è', color: 'bg-orange-500' },
    { id: 'crimproc', name: '‡∏õ.‡∏ß‡∏¥ ‡∏≠‡∏≤‡∏ç‡∏≤', icon: 'üìú', color: 'bg-blue-600' },
    { id: 'crimact', name: '‡∏û‡∏£‡∏ö.‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏ó‡∏©‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏ç‡∏≤', icon: 'üö®', color: 'bg-red-600' },
    { id: 'child', name: '‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡πà‡∏≠‡πÄ‡∏î‡πá‡∏Å', icon: 'üßí', color: 'bg-emerald-500' },
    { id: 'prevent', name: '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏≤‡∏ö‡∏õ‡∏£‡∏≤‡∏°', icon: 'üëÆ', color: 'bg-slate-700' },
    { id: 'forensic', name: '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', icon: 'üß™', color: 'bg-purple-500' },
    { id: 'investigate', name: '‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô', icon: 'üîç', color: 'bg-indigo-600' },
    { id: 'record', name: '‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏ä‡∏ç‡∏≤‡∏Å‡∏£', icon: 'üìÇ', color: 'bg-amber-600' },
    { id: 'police', name: '‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ', icon: 'üìã', color: 'bg-cyan-600' },
    { id: 'mediate', name: '‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢', icon: 'ü§ù', color: 'bg-teal-500' }
  ];

  const [newNote, setNewNote] = useState({ subjectId: '', topic: '', content: '', aiInsight: '', isExamFocus: false });
  const [newHomework, setNewHomework] = useState({ subjectId: '', task: '', dueDate: '', priority: 'normal' });
  const [newSchedule, setNewSchedule] = useState({ subjectId: '', date: '', startTime: '', endTime: '', room: '' });

  // --- Auth & Data ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const notesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'notes');
    const unsubNotes = onSnapshot(notesRef, (snap) => setNotes(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const hwRef = collection(db, 'artifacts', appId, 'users', user.uid, 'homework');
    const unsubHw = onSnapshot(hwRef, (snap) => setHomework(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const schedRef = collection(db, 'artifacts', appId, 'users', user.uid, 'schedules');
    const unsubSched = onSnapshot(schedRef, (snap) => setSchedules(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    return () => { unsubNotes(); unsubHw(); unsubSched(); };
  }, [user]);

  // --- Search Logic ---
  const filteredNotes = useMemo(() => {
    return notes.filter(n => 
      n.topic.toLowerCase().includes(searchQuery.toLowerCase()) || 
      n.content.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }, [notes, searchQuery]);

  const examFocusNotes = useMemo(() => notes.filter(n => n.isExamFocus), [notes]);

  // --- Actions ---
  const handleSaveNote = async () => {
    if (!user || !newNote.subjectId || !newNote.topic) return;
    setIsSaving(true);
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'notes'), {
        ...newNote,
        highlights: [],
        createdAt: new Date().toISOString()
      });
      setNewNote({ subjectId: '', topic: '', content: '', aiInsight: '', isExamFocus: false });
      setActiveTab('dashboard');
    } catch (e) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); } finally { setIsSaving(false); }
  };

  const toggleExamFocus = async (note) => {
    if (!user) return;
    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'notes', note.id), {
      isExamFocus: !note.isExamFocus
    });
  };

  const performGeminiScan = async () => {
    if (!scanPreview || !user) return;
    setIsScanning(true);
    const apiKey = ""; 
    const base64Image = scanPreview.split(',')[1];
    
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: "‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏ö‡πà‡∏á‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏™‡∏≠‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‡πÇ‡∏î‡∏¢‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô [CONTENT] ‡πÅ‡∏•‡∏∞ [INSIGHT]" },
              { inlineData: { mimeType: "image/png", data: base64Image } }
            ]
          }]
        })
      });
      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
      const contentMatch = text.match(/\[CONTENT\]([\s\S]*?)\[INSIGHT\]/);
      const insightMatch = text.match(/\[INSIGHT\]([\s\S]*)/);
      setNewNote(prev => ({ 
        ...prev, 
        content: contentMatch ? contentMatch[1].trim() : text,
        aiInsight: insightMatch ? insightMatch[1].trim() : ""
      }));
      setScanPreview(null);
    } catch (e) { alert("AI ‡∏™‡πÅ‡∏Å‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); } finally { setIsScanning(false); }
  };

  const HighlightableText = ({ text, highlights, onWordClick, isEditMode }) => {
    const segments = text.split(/(\s+)/);
    return (
      <div className="leading-relaxed text-slate-700 text-base whitespace-pre-wrap">
        {segments.map((word, i) => {
          const isSearchMatch = searchQuery && word.toLowerCase().includes(searchQuery.toLowerCase());
          return (
            <span 
              key={i}
              onClick={() => isEditMode && onWordClick(i)}
              className={`transition-colors rounded px-0.5 
                ${highlights?.includes(i) ? 'bg-yellow-300' : ''} 
                ${isSearchMatch ? 'bg-amber-100 ring-1 ring-amber-400 font-bold' : ''}
                ${isEditMode ? 'cursor-pointer hover:bg-slate-200' : ''}`}
            >
              {word}
            </span>
          );
        })}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-[#F8FAFC] text-slate-900 pb-32 font-sans">
      {/* Search Header */}
      <header className="bg-white/90 backdrop-blur-xl sticky top-0 z-50 border-b border-slate-100 px-6 py-4 flex flex-col gap-4 shadow-sm">
        <div className="flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-slate-900 rounded-2xl flex items-center justify-center shadow-lg shadow-slate-200">
              <Scale className="text-amber-400 w-5 h-5" />
            </div>
            <div>
              <h1 className="text-base font-black tracking-tight leading-none">LawHub</h1>
              <span className="text-[10px] font-bold text-slate-400 uppercase">Exam Readiness</span>
            </div>
          </div>
          <div className="flex gap-2">
            <button onClick={() => setActiveTab('examFocus')} className="p-2.5 bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-100 transition-colors flex items-center gap-2">
               <Target className="w-5 h-5" />
               <span className="hidden md:block text-xs font-black uppercase">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</span>
            </button>
          </div>
        </div>
        
        <div className="relative group">
          <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-amber-500 transition-colors" />
          <input 
            type="text" 
            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠..." 
            className="w-full pl-11 pr-4 py-3 bg-slate-100 border-none rounded-2xl text-sm font-medium focus:ring-2 focus:ring-amber-400 transition-all"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>
      </header>

      <main className="max-w-2xl mx-auto p-4 md:p-6 space-y-8">
        
        {activeTab === 'dashboard' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            {/* Quick Actions / Stats */}
            <div className="grid grid-cols-2 gap-4">
              <div onClick={() => setActiveTab('examFocus')} className="bg-gradient-to-br from-rose-500 to-rose-600 p-6 rounded-[2.5rem] text-white shadow-xl shadow-rose-200 cursor-pointer group">
                <div className="flex justify-between items-start mb-2">
                  <Target className="w-6 h-6 text-rose-200" />
                  <Sparkles className="w-4 h-4 text-white opacity-50 group-hover:rotate-12 transition-transform" />
                </div>
                <h2 className="text-3xl font-black">{examFocusNotes.length}</h2>
                <p className="text-[10px] font-bold text-rose-100 uppercase tracking-widest">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏™‡∏≠‡∏ö</p>
              </div>
              <div onClick={() => setActiveTab('homework')} className="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm cursor-pointer">
                <div className="flex justify-between items-start mb-2">
                  <ListTodo className="w-6 h-6 text-slate-400" />
                </div>
                <h2 className="text-3xl font-black text-slate-800">{homework.filter(h => !h.completed).length}</h2>
                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á</p>
              </div>
            </div>

            {/* Today's Schedule Mini */}
            {schedules.some(s => s.date === new Date().toISOString().split('T')[0]) && (
              <section className="bg-slate-900 rounded-[2.5rem] p-6 text-white overflow-hidden relative">
                 <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?</h3>
                 <div className="space-y-3 relative z-10">
                    {schedules.filter(s => s.date === new Date().toISOString().split('T')[0]).map(s => (
                      <div key={s.id} className="flex justify-between items-center border-b border-white/5 pb-2">
                        <span className="font-bold text-sm">{subjects.find(sb => sb.id === s.subjectId)?.name}</span>
                        <span className="text-xs text-amber-400">{s.startTime}</span>
                      </div>
                    ))}
                 </div>
              </section>
            )}

            {/* Results or Subject Grid */}
            <section className="space-y-4">
              <div className="flex justify-between items-center px-2">
                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">
                  {searchQuery ? `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (${filteredNotes.length})` : '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}
                </h3>
              </div>

              {searchQuery ? (
                <div className="space-y-4">
                  {filteredNotes.map(note => (
                    <div key={note.id} onClick={() => { 
                      setSelectedSubject(subjects.find(s => s.id === note.subjectId)); 
                      setActiveTab('viewSubject');
                    }} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer">
                       <div className="flex justify-between items-start mb-2">
                         <span className="text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded-md uppercase">
                           {subjects.find(s => s.id === note.subjectId)?.name}
                         </span>
                         {note.isExamFocus && <Target className="w-4 h-4 text-rose-500" />}
                       </div>
                       <h4 className="font-black text-slate-800">{note.topic}</h4>
                       <p className="text-xs text-slate-500 line-clamp-2 mt-1">{note.content}</p>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="grid grid-cols-1 gap-3">
                  {subjects.map(sub => (
                    <div key={sub.id} onClick={() => { setSelectedSubject(sub); setActiveTab('viewSubject'); }} className="bg-white p-4 rounded-3xl border border-slate-100 hover:border-amber-300 transition-all cursor-pointer flex items-center justify-between group">
                      <div className="flex items-center gap-4">
                        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-inner ${sub.color.replace('bg-', 'bg-opacity-10 text-')}`}>{sub.icon}</div>
                        <div>
                          <p className="font-bold text-sm text-slate-800">{sub.name}</p>
                          <span className="text-[10px] text-slate-400 font-bold uppercase">{notes.filter(n => n.subjectId === sub.id).length} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                        </div>
                      </div>
                      <ChevronRight className="w-4 h-4 text-slate-300 group-hover:text-amber-500 transition-colors" />
                    </div>
                  ))}
                </div>
              )}
            </section>
          </div>
        )}

        {activeTab === 'examFocus' && (
          <div className="space-y-8 animate-in slide-in-from-right-10 duration-500">
             <div className="flex items-center gap-4">
                <button onClick={() => setActiveTab('dashboard')} className="p-3 bg-white rounded-2xl shadow-sm"><ChevronRight className="w-5 h-5 rotate-180" /></button>
                <div>
                  <h2 className="text-xl font-black">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏≠‡∏ö üìå</h2>
                  <p className="text-xs text-slate-400 font-bold uppercase tracking-tighter">‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                </div>
             </div>

             <div className="space-y-4">
                {examFocusNotes.length > 0 ? examFocusNotes.map(note => (
                  <div key={note.id} className="bg-white p-8 rounded-[2.5rem] border-2 border-rose-100 shadow-xl shadow-rose-50/50 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-24 h-24 bg-rose-50 -mr-12 -mt-12 rounded-full opacity-50"></div>
                    <div className="relative z-10 space-y-4">
                      <div className="flex justify-between items-start">
                        <span className="text-[10px] font-black text-rose-500 bg-rose-50 px-3 py-1 rounded-full uppercase tracking-widest">
                          {subjects.find(s => s.id === note.subjectId)?.name}
                        </span>
                        <button onClick={() => toggleExamFocus(note)} className="text-rose-500 hover:scale-110 transition-transform"><Bookmark className="w-5 h-5 fill-current" /></button>
                      </div>
                      <h3 className="text-xl font-black text-slate-800">{note.topic}</h3>
                      <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <p className="text-sm text-slate-600 leading-relaxed line-clamp-4">{note.content}</p>
                      </div>
                      <button onClick={() => { setSelectedSubject(subjects.find(s => s.id === note.subjectId)); setActiveTab('viewSubject'); }} className="w-full py-3 bg-slate-900 text-white rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-slate-800 transition-colors">‡∏≠‡πà‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°</button>
                    </div>
                  </div>
                )) : (
                  <div className="text-center py-20 bg-white rounded-[3rem] border border-dashed border-slate-200">
                    <Target className="w-12 h-12 text-slate-200 mx-auto mb-4" />
                    <p className="text-slate-400 font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤ "‡∏≠‡∏≠‡∏Å‡∏™‡∏≠‡∏ö"</p>
                    <p className="text-[10px] text-slate-300 uppercase mt-1">‡∏Å‡∏î üìå ‡πÉ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>
                  </div>
                )}
             </div>
          </div>
        )}

        {activeTab === 'addNote' && (
          <div className="bg-white rounded-[3rem] p-8 shadow-2xl border border-slate-50 space-y-8 animate-in slide-in-from-bottom-10">
            <div className="flex items-center justify-between">
              <button onClick={() => setActiveTab('dashboard')} className="p-3 bg-slate-50 rounded-2xl"><X className="w-5 h-5" /></button>
              <h2 className="font-black text-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
              <div className="flex items-center gap-2">
                <button 
                  onClick={() => setNewNote({...newNote, isExamFocus: !newNote.isExamFocus})} 
                  className={`p-3 rounded-2xl transition-all ${newNote.isExamFocus ? 'bg-rose-500 text-white' : 'bg-slate-50 text-slate-300'}`}
                >
                  <Target className="w-5 h-5" />
                </button>
              </div>
            </div>

            <div onClick={() => !isScanning && fileInputRef.current.click()} className="relative aspect-[4/3] bg-slate-50 border-2 border-dashed border-slate-200 rounded-[2.5rem] flex flex-col items-center justify-center cursor-pointer overflow-hidden group">
              {scanPreview ? <img src={scanPreview} className="w-full h-full object-cover" /> : (
                <div className="text-center">
                  <div className="w-16 h-16 bg-white rounded-3xl shadow-lg flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                    <Camera className="w-7 h-7 text-slate-400" />
                  </div>
                  <p className="text-xs font-black text-slate-400 uppercase tracking-widest px-8">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÄ‡∏ô‡πâ‡∏ô</p>
                </div>
              )}
              {isScanning && (
                <div className="absolute inset-0 bg-slate-900/90 backdrop-blur-xl flex flex-col items-center justify-center text-white p-8 text-center">
                  <Loader2 className="w-12 h-12 animate-spin text-amber-400 mb-4" />
                  <p className="text-xl font-black">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≠‡∏ö...</p>
                </div>
              )}
              {scanPreview && !isScanning && (
                <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                   <button onClick={(e) => {e.stopPropagation(); performGeminiScan();}} className="bg-amber-400 text-slate-900 px-8 py-3 rounded-2xl font-black shadow-2xl">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ AI</button>
                </div>
              )}
              <input type="file" ref={fileInputRef} onChange={(e) => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onloadend = () => setScanPreview(reader.result);
                  reader.readAsDataURL(file);
                }
              }} className="hidden" accept="image/*" />
            </div>

            <div className="space-y-6">
              <div className="grid grid-cols-2 gap-4">
                <select className="p-4 rounded-2xl bg-slate-50 border-none ring-1 ring-slate-100 font-bold text-sm" value={newNote.subjectId} onChange={(e) => setNewNote({...newNote, subjectId: e.target.value})}>
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>
                  {subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                </select>
                <input className="p-4 rounded-2xl bg-slate-50 border-none ring-1 ring-slate-100 font-bold text-sm" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å..." value={newNote.topic} onChange={(e) => setNewNote({...newNote, topic: e.target.value})} />
              </div>
              <textarea rows="8" className="w-full p-6 rounded-[2rem] bg-slate-50 border-none ring-1 ring-slate-100 text-sm leading-relaxed" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç..." value={newNote.content} onChange={(e) => setNewNote({...newNote, content: e.target.value})} />
              <button onClick={handleSaveNote} disabled={isSaving || !newNote.content} className="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all">
                {isSaving ? <Loader2 className="w-6 h-6 animate-spin" /> : <><SaveAll className="w-6 h-6 text-amber-400" /> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</>}
              </button>
            </div>
          </div>
        )}

        {activeTab === 'viewSubject' && selectedSubject && (
          <div className="space-y-8 animate-in fade-in duration-300">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <button onClick={() => setActiveTab('dashboard')} className="p-3 bg-white rounded-2xl shadow-sm"><ChevronRight className="w-5 h-5 rotate-180" /></button>
                <h2 className="text-xl font-black">{selectedSubject.name}</h2>
              </div>
            </div>

            <div className="space-y-6">
              {notes.filter(n => n.subjectId === selectedSubject.id).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map(note => {
                const isEditing = editingNoteId === note.id;
                const isHighlighting = highlightingNoteId === note.id;
                
                return (
                  <div key={note.id} className={`bg-white rounded-[3rem] shadow-sm border ${note.isExamFocus ? 'border-rose-200' : 'border-slate-100'} overflow-hidden transition-all`}>
                    <div className="p-8 space-y-6">
                      <div className="flex justify-between items-start">
                        <div className="space-y-1">
                          <h4 className="text-xl font-black text-slate-900">{note.topic}</h4>
                          <div className="flex gap-2">
                             <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">{new Date(note.createdAt).toLocaleDateString('th-TH')}</p>
                             {note.isExamFocus && <span className="text-[10px] font-black text-rose-500 uppercase flex items-center gap-1"><Target className="w-2.5 h-2.5" /> ‡∏°‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏™‡∏≠‡∏ö</span>}
                          </div>
                        </div>
                        <div className="flex gap-1">
                           <button onClick={() => toggleExamFocus(note)} className={`p-2.5 rounded-xl transition-all ${note.isExamFocus ? 'bg-rose-500 text-white shadow-lg' : 'bg-slate-50 text-slate-300'}`}><Target className="w-5 h-5" /></button>
                           <button onClick={() => setHighlightingNoteId(isHighlighting ? null : note.id)} className={`p-2.5 rounded-xl transition-all ${isHighlighting ? 'bg-amber-400 text-white shadow-lg' : 'bg-slate-50 text-slate-300'}`}><Highlighter className="w-5 h-5" /></button>
                           <button onClick={() => setEditingNoteId(isEditing ? null : note.id)} className={`p-2.5 rounded-xl transition-all ${isEditing ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-50 text-slate-300'}`}><Edit3 className="w-5 h-5" /></button>
                        </div>
                      </div>

                      <div className="space-y-4">
                        {isEditing ? (
                          <textarea 
                            rows="10"
                            className="w-full bg-slate-50 border-none rounded-3xl p-6 text-sm leading-relaxed ring-1 ring-slate-100"
                            value={note.content}
                            onChange={(e) => updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'notes', note.id), { content: e.target.value })}
                          />
                        ) : (
                          <HighlightableText 
                            text={note.content} 
                            highlights={note.highlights} 
                            onWordClick={(idx) => {
                              const current = note.highlights || [];
                              const updated = current.includes(idx) ? current.filter(i => i !== idx) : [...current, idx];
                              updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'notes', note.id), { highlights: updated });
                            }}
                            isEditMode={isHighlighting}
                          />
                        )}
                      </div>
                      
                      {note.aiInsight && (
                        <div className="p-6 bg-amber-50 rounded-3xl border border-amber-100">
                          <p className="text-[10px] font-black text-amber-600 uppercase mb-2 flex items-center gap-2"><Brain className="w-3 h-3" /> ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≠‡∏ö</p>
                          <p className="text-sm text-amber-900 leading-relaxed italic whitespace-pre-wrap">{note.aiInsight}</p>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Schedule & Homework tabs remain available via Bottom Nav or Mini Icons */}
        {activeTab === 'schedules' && (
           <div className="space-y-6 animate-in slide-in-from-right-10">
              <div className="flex items-center gap-4">
                  <button onClick={() => setActiveTab('dashboard')} className="p-3 bg-white rounded-2xl shadow-sm"><ChevronRight className="w-5 h-5 rotate-180" /></button>
                  <h2 className="text-xl font-black">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h2>
              </div>
              {/* Reuse the Schedule Form and List from previous version */}
              <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-4">
                 <div className="grid grid-cols-2 gap-3">
                    <select className="p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold" value={newSchedule.subjectId} onChange={(e) => setNewSchedule({...newSchedule, subjectId: e.target.value})}>
                      <option value="">‡∏ß‡∏¥‡∏ä‡∏≤</option>
                      {subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                    </select>
                    <input type="date" className="p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold" value={newSchedule.date} onChange={(e) => setNewSchedule({...newSchedule, date: e.target.value})} />
                 </div>
                 <div className="grid grid-cols-2 gap-3">
                    <input type="time" className="p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold" value={newSchedule.startTime} onChange={(e) => setNewSchedule({...newSchedule, startTime: e.target.value})} />
                    <input className="p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold" placeholder="‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" value={newSchedule.room} onChange={(e) => setNewSchedule({...newSchedule, room: e.target.value})} />
                 </div>
                 <button onClick={async () => {
                   if (!newSchedule.date || !newSchedule.subjectId) return;
                   await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'schedules'), newSchedule);
                   setNewSchedule({ subjectId: '', date: '', startTime: '', endTime: '', room: '' });
                 }} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
              </div>
              <div className="space-y-3">
                 {schedules.map(s => (
                   <div key={s.id} className="bg-white p-5 rounded-3xl border border-slate-100 flex justify-between items-center">
                      <div>
                        <p className="font-bold text-sm">{subjects.find(sb => sb.id === s.subjectId)?.name}</p>
                        <p className="text-[10px] text-slate-400 font-bold uppercase">{s.date} | {s.startTime}</p>
                      </div>
                      <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'schedules', s.id))} className="text-slate-200 hover:text-rose-500"><Trash2 className="w-4 h-4" /></button>
                   </div>
                 ))}
              </div>
           </div>
        )}

        {activeTab === 'homework' && (
           <div className="space-y-6 animate-in slide-in-from-right-10">
              <div className="flex items-center gap-4">
                  <button onClick={() => setActiveTab('dashboard')} className="p-3 bg-white rounded-2xl shadow-sm"><ChevronRight className="w-5 h-5 rotate-180" /></button>
                  <h2 className="text-xl font-black">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô üìã</h2>
              </div>
              {/* Reuse Homework Form and List */}
              <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-4">
                 <input className="w-full p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô..." value={newHomework.task} onChange={(e) => setNewHomework({...newHomework, task: e.target.value})} />
                 <div className="grid grid-cols-2 gap-3">
                    <select className="p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold" value={newHomework.subjectId} onChange={(e) => setNewHomework({...newHomework, subjectId: e.target.value})}>
                      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>
                      {subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                    </select>
                    <input type="date" className="p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold" value={newHomework.dueDate} onChange={(e) => setNewHomework({...newHomework, dueDate: e.target.value})} />
                 </div>
                 <button onClick={async () => {
                   if (!newHomework.task || !newHomework.subjectId) return;
                   await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'homework'), { ...newHomework, completed: false });
                   setNewHomework({ subjectId: '', task: '', dueDate: '', priority: 'normal' });
                 }} className="w-full py-4 bg-amber-400 text-slate-900 rounded-2xl font-black text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
              </div>
              <div className="space-y-3">
                 {homework.map(h => (
                   <div key={h.id} className="bg-white p-5 rounded-3xl border border-slate-100 flex items-center gap-4">
                      <button onClick={() => updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'homework', h.id), { completed: !h.completed })} className={`w-10 h-10 rounded-xl flex items-center justify-center ${h.completed ? 'bg-emerald-500 text-white' : 'bg-slate-50 text-slate-300'}`}>
                        <Check className="w-5 h-5" />
                      </button>
                      <div className="flex-1">
                        <p className={`font-bold text-sm ${h.completed ? 'line-through text-slate-400' : ''}`}>{h.task}</p>
                        <p className="text-[10px] text-slate-400 font-bold uppercase">{subjects.find(sb => sb.id === h.subjectId)?.name}</p>
                      </div>
                      <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'homework', h.id))} className="text-slate-200 hover:text-rose-500"><Trash2 className="w-4 h-4" /></button>
                   </div>
                 ))}
              </div>
           </div>
        )}
      </main>

      {/* Navigation */}
      <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-2xl px-10 py-5 rounded-[2.5rem] flex items-center gap-14 shadow-2xl z-50 border border-slate-100/50">
        <button onClick={() => setActiveTab('dashboard')} className={`transition-all ${activeTab === 'dashboard' ? 'text-slate-900 scale-125' : 'text-slate-300'}`}><Layout className="w-7 h-7" /></button>
        <button onClick={() => setActiveTab('addNote')} className="bg-slate-900 text-white w-16 h-16 rounded-[1.7rem] flex items-center justify-center -mt-20 shadow-2xl shadow-slate-900/40 active:scale-90 transition-transform"><Plus className="w-9 h-9" /></button>
        <button onClick={() => setActiveTab('schedules')} className={`transition-all ${activeTab === 'schedules' ? 'text-slate-900 scale-125' : 'text-slate-300'}`}><Calendar className="w-7 h-7" /></button>
      </nav>
    </div>
  );
};

export default App;

